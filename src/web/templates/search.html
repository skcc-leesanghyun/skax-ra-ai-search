{% extends "base.html" %}

{% block title %}검색 - SKAX-RA-AI-SEARCH{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- 검색 카드 -->
    <div class="glass-card rounded-2xl shadow-2xl animate-fade-in-up">
        <div class="p-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full mb-6">
                    <i class="fas fa-search text-white text-3xl"></i>
                </div>
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    AI 기반 개발자 검색
                </h1>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                    자연어로 원하는 개발자를 찾아보세요. AI가 의도를 파악하여 최적의 매칭을 제공합니다.
                </p>
            </div>
            
            <form id="searchForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-2">
                        <label for="query" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-keyboard text-primary-500 mr-2"></i>검색어
                        </label>
                        <input type="text" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all duration-300 text-lg"
                               id="query" 
                               name="query" 
                               placeholder="예: 시니어 React 개발자 서울거주" 
                               required>
                        <p class="mt-2 text-sm text-gray-500">
                            <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                            자연어로 자유롭게 입력하세요
                        </p>
                    </div>
                    
                    <div>
                        <label for="searchType" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-cog text-primary-500 mr-2"></i>검색 타입
                        </label>
                        <select class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all duration-300"
                                id="searchType" 
                                name="searchType">
                            <option value="comprehensive">종합 검색</option>
                            <option value="profile_only">프로필만</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="filterMode" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-filter text-primary-500 mr-2"></i>필터 모드
                        </label>
                        <select class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all duration-300"
                                id="filterMode" 
                                name="filterMode">
                            <option value="default">기본</option>
                            <option value="strict">엄격</option>
                            <option value="flexible">유연</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button type="submit" class="btn-gradient text-white font-semibold py-4 px-8 rounded-xl text-lg shadow-lg">
                        <i class="fas fa-search mr-2"></i>검색 시작
                    </button>
                    <button type="button" id="clearBtn" class="btn-secondary-gradient text-white font-semibold py-4 px-8 rounded-xl text-lg shadow-lg">
                        <i class="fas fa-eraser mr-2"></i>초기화
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 로딩 인디케이터 -->
    <div class="loading mt-8">
        <div class="glass-card rounded-2xl shadow-xl">
            <div class="p-12 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full mb-6 animate-pulse-slow">
                    <i class="fas fa-robot text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-primary-600 mb-3">AI가 검색 중입니다...</h3>
                <p class="text-gray-600 mb-6">벡터 데이터베이스에서 최적의 매칭을 찾고 있어요</p>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-primary-500 to-secondary-500 h-2 rounded-full animate-pulse"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 검색 결과 -->
    <div id="results" class="mt-8 space-y-6"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 검색 폼 제출
    $('#searchForm').submit(function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const query = $('#query').val().trim();
        
        formData.append('filterMode', $('#filterMode').val());
        
        if (!query) {
            showNotification('검색어를 입력해주세요.', 'warning');
            return;
        }
        
        $('.loading').fadeIn(300);
        $('#results').empty();
        
        $.ajax({
            url: '/api/search',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('.loading').fadeOut(300);
                console.log('Search response:', response);
                
                if (response && response.success) {
                    displayResults(response.results, response.query, response);
                } else {
                    const errorMsg = response && response.error ? response.error : '알 수 없는 오류가 발생했습니다.';
                    showNotification(errorMsg, 'danger');
                }
            },
            error: function() {
                $('.loading').fadeOut(300);
                showNotification('서버 오류가 발생했습니다.', 'danger');
            }
        });
    });
    
    // 초기화 버튼
    $('#clearBtn').click(function() {
        $('#query').val('').focus();
        $('#results').empty();
        showNotification('검색 조건이 초기화되었습니다.', 'info');
    });
    
    // 알림 표시 함수
    function showNotification(message, type) {
        const icons = {
            success: 'check-circle',
            warning: 'exclamation-triangle',
            danger: 'times-circle',
            info: 'info-circle'
        };
        
        const colors = {
            success: 'green',
            warning: 'yellow',
            danger: 'red',
            info: 'blue'
        };
        
        const alertHtml = `
            <div class="bg-${colors[type]}-50 border border-${colors[type]}-200 rounded-xl p-4 animate-fade-in">
                <div class="flex items-center">
                    <i class="fas fa-${icons[type]} text-${colors[type]}-500 mr-3 text-xl"></i>
                    <span class="text-${colors[type]}-800 font-medium">${message}</span>
                    <button type="button" class="ml-auto text-${colors[type]}-400 hover:text-${colors[type]}-600" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        $('#results').html(alertHtml);
    }
    
    // 검색 결과 표시
    function displayResults(results, query, response) {
        if (!results || !Array.isArray(results)) {
            showNotification('검색 결과를 처리할 수 없습니다.', 'warning');
            return;
        }
        
        if (results.length === 0) {
            showNotification(`"${query}"에 대한 검색 결과가 없습니다. 필터 조건을 완화해보세요.`, 'info');
            return;
        }
        
        // 필터 정보 표시
        let filterInfo = '';
        if (response.filter_info) {
            filterInfo = `
                <div class="glass-card rounded-xl p-6 animate-fade-in-up">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-filter text-white text-lg"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-900">적용된 필터</h3>
                            <p class="text-gray-600">${response.filter_info}</p>
                            <p class="text-sm text-gray-500">필터 모드: ${response.filter_mode}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        let html = `
            ${filterInfo}
            <div class="glass-card rounded-xl p-6 animate-fade-in-up">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">
                            <i class="fas fa-list text-primary-500 mr-2"></i>
                            검색 결과
                        </h2>
                        <p class="text-gray-600">
                            <i class="fas fa-users mr-1"></i>
                            ${results.length}명의 개발자를 찾았습니다
                        </p>
                    </div>
                    <div class="mt-4 sm:mt-0">
                        <span class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-semibold rounded-full text-sm">
                            <i class="fas fa-quote-left mr-2"></i>
                            "${query}"
                        </span>
                    </div>
                </div>
            </div>
        `;
        
        // 개발자 카드들
        results.forEach((result, index) => {
            if (!result || !result.metadata) {
                console.warn('Invalid result at index:', index, result);
                return;
            }
            
            const metadata = result.metadata;
            const recommendationPercent = Math.max(50, 100 - (index * 5));
            const delay = index * 0.1;
            
            html += `
                <div class="glass-card rounded-xl p-6 card-hover animate-fade-in-up" style="animation-delay: ${delay}s;">
                    <div class="flex flex-col lg:flex-row lg:items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-4">
                                <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-yellow-400 to-yellow-500 text-white font-bold rounded-full text-sm mr-4">
                                    <i class="fas fa-trophy mr-1"></i>#${index + 1}
                                </span>
                                <h3 class="text-xl font-bold text-gray-900">
                                    <i class="fas fa-user-circle text-primary-500 mr-2"></i>
                                    ${metadata.name}
                                </h3>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-full text-sm">
                                    <i class="fas fa-code mr-1"></i>${metadata.primary_role}
                                </span>
                                <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold rounded-full text-sm">
                                    <i class="fas fa-star mr-1"></i>${metadata.seniority}
                                </span>
                                <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-${getAvailabilityColor(metadata.availability)}-500 to-${getAvailabilityColor(metadata.availability)}-600 text-white font-semibold rounded-full text-sm">
                                    <i class="fas fa-circle mr-1"></i>${metadata.availability}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                                    ${metadata.location}
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-clock text-gray-400 mr-2"></i>
                                    ${metadata.years_experience}년 경력
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-dollar-sign text-gray-400 mr-2"></i>
                                    ${metadata.salary_range}만원
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-id-card text-gray-400 mr-2"></i>
                                    ${metadata.developer_id}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 lg:mt-0 lg:ml-6 text-center">
                            <div class="mb-4">
                                <div class="score-circle w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-2" style="--percentage: ${recommendationPercent * 3.6}deg;">
                                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center font-bold text-green-600">
                                        ${recommendationPercent}%
                                    </div>
                                </div>
                                <p class="text-sm font-semibold text-gray-600">추천도</p>
                            </div>
                            
                            <a href="/profile/${metadata.developer_id}" 
                               class="inline-flex items-center px-6 py-3 border-2 border-primary-500 text-primary-600 font-semibold rounded-xl hover:bg-primary-500 hover:text-white transition-all duration-300">
                                <i class="fas fa-eye mr-2"></i>상세보기
                            </a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#results').html(html);
    }
    
    function getAvailabilityColor(availability) {
        switch(availability) {
            case 'available': return 'green';
            case 'busy': return 'yellow';
            case 'considering': return 'blue';
            default: return 'gray';
        }
    }
    
    // 검색어 입력 필드에 포커스
    $('#query').focus();
});
</script>
{% endblock %}
